import { Subject } from 'rxjs';
import { first as first_, tap } from 'rxjs/operators';
export class ContentManager {
    constructor() {
        this.messages = [];
        this.revision = 0;
        this.visibleRevision = 0;
        this.inputs = new Subject();
        this.updated = new Subject();
        this.inputEnabled = false;
        this.textArea = false;
        this.inputKind = 'text';
        this.placeholder = '';
        this.validator = null;
        this.fastScroll = false;
        this.scrollLock = false;
        this.fixme = null;
        this.debug = false;
        this.sendButtonText = 'Send';
        this.inputPlaceholder = 'Type something...';
        this.uploadFileText = 'Upload File...';
        this.uploadedFileText = 'Uploaded Successfully';
        this.notUploadedFileText = 'Failed to upload file';
        this.fixmeMessage = 'Fix';
        this.timeout = 1000;
        this.toQueue = [];
    }
    clear() {
        this.messages = [];
        this.toQueue = [];
    }
    reportValue(value) {
        this.inputs.next(value);
    }
    reportUpdated(value) {
        if (this.debug) {
            console.log('CONTENT UPDATED', this.timeout);
        }
        if (this.timeout) {
            window.setTimeout(() => {
                this.updated.next(value);
            }, this.timeout);
        }
    }
    add(kind, params) {
        const first = (this.messages.length === 0 ||
            kind !== this.messages[this.messages.length - 1].kind);
        const revision = this.revision;
        this.messages.push({ kind, params, first, revision });
    }
    queue(kind, params) {
        this.toQueue.push({ kind, params });
        if (this.toQueue.length === 1) {
            this.typing();
        }
    }
    queueFunction(callable) {
        return new Promise((resolve) => {
            this.queue('function', { callable, resolve });
        });
    }
    typing() {
        if (this.debug) {
            console.log('TYPING, queue len=' + this.toQueue.length);
        }
        if (this.toQueue.length > 0) {
            const item = this.toQueue[0];
            if (this.debug) {
                console.log('item=', item);
            }
            if (item.kind === 'function') {
                if (this.debug) {
                    console.log('RUNNING FUNCTION', item);
                }
                this.toQueue.shift();
                const future = item.params.callable();
                future.then((result) => {
                    if (this.debug) {
                        console.log('FUNCTION RESOLVED to', result, item);
                    }
                    item.params.resolve(result);
                    this.typing();
                });
            }
            else {
                this.add('typing', null);
                const callback = () => {
                    this.toQueue.shift();
                    if (this.debug) {
                        console.log('handling item=', item);
                    }
                    this.replace(item.kind, item.params);
                    this.typing();
                };
                let timeout = this.timeout;
                if (this.toQueue.length > 0) {
                    let stepTimeout = this.toQueue[0].params.timeout;
                    if (stepTimeout || stepTimeout === 0) {
                        timeout = stepTimeout;
                    }
                }
                if (timeout === 0) {
                    callback();
                }
                else {
                    window.setTimeout(() => {
                        callback();
                        this.reportUpdated(item);
                    }, timeout);
                }
            }
        }
        else {
            window.setTimeout(async () => {
                this.reportUpdated(null);
            }, this.timeout);
        }
    }
    replace(kind, params) {
        const first = (this.messages.length < 2 || kind !== this.messages[this.messages.length - 2].kind);
        this.messages[this.messages.length - 1] = { kind, params, first };
    }
    addFrom(message) {
        this.add('from', { message, fixme: this.fixme, fixmeMessage: this.fixmeMessage });
    }
    reportInput(value) {
        this.reportValue(value);
        this.reportUpdated(value);
        this.textArea = false;
        this.placeholder = '';
        this.validator = null;
    }
    queueFrom(message, timeout) {
        this.queue('from', { message, fixme: this.fixme, fixmeMessage: this.fixmeMessage, timeout });
    }
    addTo(message, timeout) {
        this.queue('to', { message, timeout });
    }
    addOptions(message, options, selected, multi) {
        if (message) {
            this.queue('to', { message });
        }
        this.queue('options', { options, selected, multi, fixme: this.fixme, fixmeMessage: this.fixmeMessage });
    }
    addUploader(message, options) {
        if (message) {
            this.queue('to', { message });
        }
        this.queue('uploader', options);
    }
    addCustomComponent(step, wait, timeout) {
        return new Promise((componentCreatedCallback) => {
            this.queue('component', {
                step,
                timeout,
                componentCreatedCallback: () => {
                    if (this.debug) {
                        console.log('CUSTOM COMPONENT CREATED', step);
                    }
                    return componentCreatedCallback();
                }
            });
        }).then(() => {
            if (wait) {
                return this.queueFunction(() => {
                    return step.__instance.wait();
                });
            }
            else {
                return;
            }
        });
    }
    setTextArea() {
        this.textArea = true;
    }
    setInputKind(kind, required, min, max, step) {
        this.inputKind = kind || 'text';
        this.inputRequired = !!required,
            this.inputMin = min === undefined ? null : min;
        this.inputMax = max === undefined ? null : max;
        this.inputStep = step === undefined ? null : step;
    }
    setInputSuggestions(suggestions) {
        this.inputSuggestions = suggestions;
    }
    setPlaceholder(placeholder) {
        this.placeholder = placeholder;
    }
    setValidator(validator) {
        this.validator = validator;
    }
    setFixme(fixme) {
        this.fixme = fixme;
    }
    setFastScroll(value) {
        this.fastScroll = value;
    }
    setScrollLock(value) {
        if (this.scrollLock !== value) {
            this.scrollLock = value;
            if (value) {
                this.revision += 1;
            }
            else {
                this.visibleRevision = this.revision;
                if (this.debug) {
                    console.log('SETTING VISIBLE REVISION', this.visibleRevision, 'LAST MESSAGE', this.messages[this.messages.length - 1]);
                }
            }
        }
    }
    async waitForInput(enableTextInput) {
        enableTextInput = (enableTextInput !== false);
        let activeElement = null;
        if (enableTextInput) {
            await this.queueFunction(async () => {
                if (this.debug) {
                    console.log('ENABLING INPUT');
                }
                activeElement = document.activeElement;
                this.inputEnabled = true;
            });
        }
        return this.inputs.pipe(first_(), tap((value) => {
            if (this.debug) {
                console.log('DISABLING INPUT, value=', value);
            }
            this.inputEnabled = false;
            console.log('FOCUSING', activeElement);
            activeElement?.focus();
        })).toPromise();
    }
    setQueueTimeout(timeout) {
        let report = false;
        if (this.timeout === 0 && timeout !== 0) {
            report = true;
        }
        this.timeout = timeout;
        if (report) {
            this.reportUpdated(null);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvaGF0b29sL3NyYy9saWIvY29udGVudC1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLEtBQUssSUFBSSxNQUFNLEVBQUUsR0FBRyxFQUFhLE1BQU0sZ0JBQWdCLENBQUM7QUFHakUsTUFBTSxPQUFPLGNBQWM7SUFpQ3pCO1FBL0JPLGFBQVEsR0FBVSxFQUFFLENBQUM7UUFDckIsYUFBUSxHQUFHLENBQUMsQ0FBQztRQUNiLG9CQUFlLEdBQUcsQ0FBQyxDQUFDO1FBRXBCLFdBQU0sR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1FBQzVCLFlBQU8sR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1FBQzdCLGlCQUFZLEdBQUcsS0FBSyxDQUFDO1FBQ3JCLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFDakIsY0FBUyxHQUFHLE1BQU0sQ0FBQztRQU1uQixnQkFBVyxHQUFHLEVBQUUsQ0FBQztRQUNqQixjQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLGVBQVUsR0FBRyxLQUFLLENBQUM7UUFDbkIsZUFBVSxHQUFHLEtBQUssQ0FBQztRQUNuQixVQUFLLEdBQWUsSUFBSSxDQUFDO1FBQ3pCLFVBQUssR0FBRyxLQUFLLENBQUM7UUFFZCxtQkFBYyxHQUFHLE1BQU0sQ0FBQztRQUN4QixxQkFBZ0IsR0FBRyxtQkFBbUIsQ0FBQztRQUN2QyxtQkFBYyxHQUFHLGdCQUFnQixDQUFDO1FBQ2xDLHFCQUFnQixHQUFHLHVCQUF1QixDQUFDO1FBQzNDLHdCQUFtQixHQUFHLHVCQUF1QixDQUFDO1FBQzlDLGlCQUFZLEdBQUcsS0FBSyxDQUFDO1FBQ3JCLFlBQU8sR0FBRyxJQUFJLENBQUM7UUFFdEIsWUFBTyxHQUFHLEVBQUUsQ0FBQztJQUVHLENBQUM7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S0FBSyxDQUFDLEVBQUUsQ0FBQztZQUN4QyxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLENBQUM7UUFDRCxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQ1gsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQixDQUFDO0lBQ0gsQ0FBQztDQUVGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlyc3QgYXMgZmlyc3RfLCB0YXAsIHRpbWVzdGFtcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFdhaXRhYmxlIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcblxuZXhwb3J0IGNsYXNzIENvbnRlbnRNYW5hZ2VyIHtcblxuICBwdWJsaWMgbWVzc2FnZXM6IGFueVtdID0gW107XG4gIHB1YmxpYyByZXZpc2lvbiA9IDA7XG4gIHB1YmxpYyB2aXNpYmxlUmV2aXNpb24gPSAwO1xuXG4gIHB1YmxpYyBpbnB1dHMgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG4gIHB1YmxpYyB1cGRhdGVkID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICBwdWJsaWMgaW5wdXRFbmFibGVkID0gZmFsc2U7XG4gIHB1YmxpYyB0ZXh0QXJlYSA9IGZhbHNlO1xuICBwdWJsaWMgaW5wdXRLaW5kID0gJ3RleHQnO1xuICBwdWJsaWMgaW5wdXRNaW47XG4gIHB1YmxpYyBpbnB1dE1heDtcbiAgcHVibGljIGlucHV0U3RlcDtcbiAgcHVibGljIGlucHV0U3VnZ2VzdGlvbnM7XG4gIHB1YmxpYyBpbnB1dFJlcXVpcmVkO1xuICBwdWJsaWMgcGxhY2Vob2xkZXIgPSAnJztcbiAgcHVibGljIHZhbGlkYXRvciA9IG51bGw7XG4gIHB1YmxpYyBmYXN0U2Nyb2xsID0gZmFsc2U7XG4gIHB1YmxpYyBzY3JvbGxMb2NrID0gZmFsc2U7XG4gIHB1YmxpYyBmaXhtZTogKCkgPT4gdm9pZCA9IG51bGw7XG4gIHB1YmxpYyBkZWJ1ZyA9IGZhbHNlO1xuXG4gIHB1YmxpYyBzZW5kQnV0dG9uVGV4dCA9ICdTZW5kJztcbiAgcHVibGljIGlucHV0UGxhY2Vob2xkZXIgPSAnVHlwZSBzb21ldGhpbmcuLi4nO1xuICBwdWJsaWMgdXBsb2FkRmlsZVRleHQgPSAnVXBsb2FkIEZpbGUuLi4nO1xuICBwdWJsaWMgdXBsb2FkZWRGaWxlVGV4dCA9ICdVcGxvYWRlZCBTdWNjZXNzZnVsbHknO1xuICBwdWJsaWMgbm90VXBsb2FkZWRGaWxlVGV4dCA9ICdGYWlsZWQgdG8gdXBsb2FkIGZpbGUnO1xuICBwdWJsaWMgZml4bWVNZXNzYWdlID0gJ0ZpeCc7XG4gIHB1YmxpYyB0aW1lb3V0ID0gMTAwMDtcblxuICB0b1F1ZXVlID0gW107XG5cbiAgY29uc3RydWN0b3IoKSB7IH1cblxuICBjbGVhcigpIHtcbiAgICB0aGlzLm1lc3NhZ2VzID0gW107XG4gICAgdGhpcy50b1F1ZXVlID0gW107XG4gIH1cblxuICByZXBvcnRWYWx1ZSh2YWx1ZSkge1xuICAgIHRoaXMuaW5wdXRzLm5leHQodmFsdWUpO1xuICB9XG5cbiAgcmVwb3J0VXBkYXRlZCh2YWx1ZSkge1xuICAgIGlmICh0aGlzLmRlYnVnKSB7XG4gICAgICBjb25zb2xlLmxvZygnQ09OVEVOVCBVUERBVEVEJywgdGhpcy50aW1lb3V0KTtcbiAgICB9XG4gICAgaWYgKHRoaXMudGltZW91dCkge1xuICAgICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLnVwZGF0ZWQubmV4dCh2YWx1ZSk7XG4gICAgICB9LCB0aGlzLnRpbWVvdXQpO1xuICAgIH1cbiAgfVxuXG4gIGFkZChraW5kLCBwYXJhbXMpIHtcbiAgICBjb25zdCBmaXJzdCA9IChcbiAgICAgIHRoaXMubWVzc2FnZXMubGVuZ3RoID09PSAwIHx8XG4gICAgICBraW5kICE9PSB0aGlzLm1lc3NhZ2VzW3RoaXMubWVzc2FnZXMubGVuZ3RoIC0gMV0ua2luZFxuICAgICk7XG4gICAgY29uc3QgcmV2aXNpb24gPSB0aGlzLnJldmlzaW9uO1xuICAgIHRoaXMubWVzc2FnZXMucHVzaCh7a2luZCwgcGFyYW1zLCBmaXJzdCwgcmV2aXNpb259KTtcbiAgfVxuXG4gIHF1ZXVlKGtpbmQsIHBhcmFtcykge1xuICAgIHRoaXMudG9RdWV1ZS5wdXNoKHtraW5kLCBwYXJhbXN9KTtcbiAgICBpZiAodGhpcy50b1F1ZXVlLmxlbmd0aCA9PT0gMSkge1xuICAgICAgdGhpcy50eXBpbmcoKTtcbiAgICB9XG4gIH1cblxuICBxdWV1ZUZ1bmN0aW9uKGNhbGxhYmxlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICB0aGlzLnF1ZXVlKCdmdW5jdGlvbicsIHtjYWxsYWJsZSwgcmVzb2x2ZX0pO1xuICAgIH0pO1xuICB9XG5cbiAgdHlwaW5nKCkge1xuICAgIGlmICh0aGlzLmRlYnVnKSB7XG4gICAgICBjb25zb2xlLmxvZygnVFlQSU5HLCBxdWV1ZSBsZW49JyArIHRoaXMudG9RdWV1ZS5sZW5ndGgpO1xuICAgIH1cbiAgICBpZiAodGhpcy50b1F1ZXVlLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLnRvUXVldWVbMF07XG4gICAgICBpZiAodGhpcy5kZWJ1Zykge1xuICAgICAgICBjb25zb2xlLmxvZygnaXRlbT0nLCBpdGVtKTtcbiAgICAgIH1cbiAgICAgIGlmIChpdGVtLmtpbmQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgaWYgKHRoaXMuZGVidWcpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnUlVOTklORyBGVU5DVElPTicsIGl0ZW0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudG9RdWV1ZS5zaGlmdCgpO1xuICAgICAgICBjb25zdCBmdXR1cmUgPSBpdGVtLnBhcmFtcy5jYWxsYWJsZSgpO1xuICAgICAgICBmdXR1cmUudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuZGVidWcpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdGVU5DVElPTiBSRVNPTFZFRCB0bycsIHJlc3VsdCwgaXRlbSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGl0ZW0ucGFyYW1zLnJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgICB0aGlzLnR5cGluZygpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuYWRkKCd0eXBpbmcnLCBudWxsKTtcbiAgICAgICAgY29uc3QgY2FsbGJhY2sgPSAoKSA9PiB7XG4gICAgICAgICAgdGhpcy50b1F1ZXVlLnNoaWZ0KCk7XG4gICAgICAgICAgaWYgKHRoaXMuZGVidWcpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdoYW5kbGluZyBpdGVtPScsIGl0ZW0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLnJlcGxhY2UoaXRlbS5raW5kLCBpdGVtLnBhcmFtcyk7XG4gICAgICAgICAgdGhpcy50eXBpbmcoKTtcbiAgICAgICAgfTtcbiAgICAgICAgbGV0IHRpbWVvdXQgPSB0aGlzLnRpbWVvdXQ7XG4gICAgICAgIGlmICh0aGlzLnRvUXVldWUubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGxldCBzdGVwVGltZW91dCA9IHRoaXMudG9RdWV1ZVswXS5wYXJhbXMudGltZW91dDtcbiAgICAgICAgICBpZiAoc3RlcFRpbWVvdXQgfHwgc3RlcFRpbWVvdXQgPT09IDApIHtcbiAgICAgICAgICAgIHRpbWVvdXQgPSBzdGVwVGltZW91dDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRpbWVvdXQgPT09IDApIHtcbiAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgICAgICB0aGlzLnJlcG9ydFVwZGF0ZWQoaXRlbSk7XG4gICAgICAgICAgfSwgdGltZW91dCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgd2luZG93LnNldFRpbWVvdXQoYXN5bmMgKCkgPT4ge1xuICAgICAgICB0aGlzLnJlcG9ydFVwZGF0ZWQobnVsbCk7XG4gICAgICB9LCB0aGlzLnRpbWVvdXQpO1xuICAgIH1cbiAgfVxuXG4gIHJlcGxhY2Uoa2luZCwgcGFyYW1zKSB7XG4gICAgY29uc3QgZmlyc3QgPSAodGhpcy5tZXNzYWdlcy5sZW5ndGggPCAyIHx8IGtpbmQgIT09IHRoaXMubWVzc2FnZXNbdGhpcy5tZXNzYWdlcy5sZW5ndGggLSAyXS5raW5kKTtcbiAgICB0aGlzLm1lc3NhZ2VzW3RoaXMubWVzc2FnZXMubGVuZ3RoIC0gMV0gPSB7a2luZCwgcGFyYW1zLCBmaXJzdH07XG4gIH1cblxuICBhZGRGcm9tKG1lc3NhZ2U6IHN0cmluZykge1xuICAgIHRoaXMuYWRkKCdmcm9tJywge21lc3NhZ2UsIGZpeG1lOiB0aGlzLmZpeG1lLCBmaXhtZU1lc3NhZ2U6IHRoaXMuZml4bWVNZXNzYWdlfSk7XG4gIH1cblxuICByZXBvcnRJbnB1dCh2YWx1ZTogc3RyaW5nKSB7XG4gICAgdGhpcy5yZXBvcnRWYWx1ZSh2YWx1ZSk7XG4gICAgdGhpcy5yZXBvcnRVcGRhdGVkKHZhbHVlKTtcbiAgICB0aGlzLnRleHRBcmVhID0gZmFsc2U7XG4gICAgdGhpcy5wbGFjZWhvbGRlciA9ICcnO1xuICAgIHRoaXMudmFsaWRhdG9yID0gbnVsbDtcbiAgfVxuXG4gIHF1ZXVlRnJvbShtZXNzYWdlOiBzdHJpbmcsIHRpbWVvdXQ/KSB7XG4gICAgdGhpcy5xdWV1ZSgnZnJvbScsIHttZXNzYWdlLCBmaXhtZTogdGhpcy5maXhtZSwgZml4bWVNZXNzYWdlOiB0aGlzLmZpeG1lTWVzc2FnZSwgdGltZW91dH0pO1xuICB9XG5cbiAgYWRkVG8obWVzc2FnZTogc3RyaW5nLCB0aW1lb3V0Pykge1xuICAgIHRoaXMucXVldWUoJ3RvJywge21lc3NhZ2UsIHRpbWVvdXR9KTtcbiAgfVxuXG4gIGFkZE9wdGlvbnMobWVzc2FnZSwgb3B0aW9uczogYW55W10sIHNlbGVjdGVkPzogYW55LCBtdWx0aT86IGJvb2xlYW4pIHtcbiAgICBpZiAobWVzc2FnZSkge1xuICAgICAgdGhpcy5xdWV1ZSgndG8nLCB7bWVzc2FnZX0pO1xuICAgIH1cbiAgICB0aGlzLnF1ZXVlKCdvcHRpb25zJywge29wdGlvbnMsIHNlbGVjdGVkLCBtdWx0aSwgZml4bWU6IHRoaXMuZml4bWUsIGZpeG1lTWVzc2FnZTogdGhpcy5maXhtZU1lc3NhZ2V9KTtcbiAgfVxuXG4gIGFkZFVwbG9hZGVyKG1lc3NhZ2UsIG9wdGlvbnM/OiBhbnkpIHtcbiAgICBpZiAobWVzc2FnZSkge1xuICAgICAgdGhpcy5xdWV1ZSgndG8nLCB7bWVzc2FnZX0pO1xuICAgIH1cbiAgICB0aGlzLnF1ZXVlKCd1cGxvYWRlcicsIG9wdGlvbnMpO1xuICB9XG5cbiAgYWRkQ3VzdG9tQ29tcG9uZW50KHN0ZXAsIHdhaXQsIHRpbWVvdXQ/KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChjb21wb25lbnRDcmVhdGVkQ2FsbGJhY2spID0+IHtcbiAgICAgIHRoaXMucXVldWUoJ2NvbXBvbmVudCcsIHtcbiAgICAgICAgc3RlcCxcbiAgICAgICAgdGltZW91dCxcbiAgICAgICAgY29tcG9uZW50Q3JlYXRlZENhbGxiYWNrOiAoKSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuZGVidWcpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdDVVNUT00gQ09NUE9ORU5UIENSRUFURUQnLCBzdGVwKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGNvbXBvbmVudENyZWF0ZWRDYWxsYmFjaygpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgIGlmICh3YWl0KSB7XG4gICAgICAgIHJldHVybiB0aGlzLnF1ZXVlRnVuY3Rpb24oKCkgPT4ge1xuICAgICAgICAgIHJldHVybiAoc3RlcC5fX2luc3RhbmNlIGFzIFdhaXRhYmxlKS53YWl0KCk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgc2V0VGV4dEFyZWEoKSB7XG4gICAgdGhpcy50ZXh0QXJlYSA9IHRydWU7XG4gIH1cblxuICBzZXRJbnB1dEtpbmQoa2luZCwgcmVxdWlyZWQ/LCBtaW4/LCBtYXg/LCBzdGVwPykge1xuICAgIHRoaXMuaW5wdXRLaW5kID0ga2luZCB8fCAndGV4dCc7XG4gICAgdGhpcy5pbnB1dFJlcXVpcmVkID0gISFyZXF1aXJlZCxcbiAgICB0aGlzLmlucHV0TWluID0gbWluID09PSB1bmRlZmluZWQgPyBudWxsIDogbWluO1xuICAgIHRoaXMuaW5wdXRNYXggPSBtYXggPT09IHVuZGVmaW5lZCA/IG51bGwgOiBtYXg7XG4gICAgdGhpcy5pbnB1dFN0ZXAgPSBzdGVwID09PSB1bmRlZmluZWQgPyBudWxsIDogc3RlcDtcbiAgfVxuXG4gIHNldElucHV0U3VnZ2VzdGlvbnMoc3VnZ2VzdGlvbnM6IHN0cmluZ1tdKSB7XG4gICAgdGhpcy5pbnB1dFN1Z2dlc3Rpb25zID0gc3VnZ2VzdGlvbnM7XG4gIH1cblxuICBzZXRQbGFjZWhvbGRlcihwbGFjZWhvbGRlcikge1xuICAgIHRoaXMucGxhY2Vob2xkZXIgPSBwbGFjZWhvbGRlcjtcbiAgfVxuXG4gIHNldFZhbGlkYXRvcih2YWxpZGF0b3IpIHtcbiAgICB0aGlzLnZhbGlkYXRvciA9IHZhbGlkYXRvcjtcbiAgfVxuXG4gIHNldEZpeG1lKGZpeG1lOiAoKSA9PiB2b2lkKSB7XG4gICAgdGhpcy5maXhtZSA9IGZpeG1lO1xuICB9XG5cbiAgc2V0RmFzdFNjcm9sbCh2YWx1ZTogYm9vbGVhbikge1xuICAgIHRoaXMuZmFzdFNjcm9sbCA9IHZhbHVlO1xuICB9XG5cbiAgc2V0U2Nyb2xsTG9jayh2YWx1ZTogYm9vbGVhbikge1xuICAgIGlmICh0aGlzLnNjcm9sbExvY2sgIT09IHZhbHVlKSB7XG4gICAgICB0aGlzLnNjcm9sbExvY2sgPSB2YWx1ZTtcbiAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICB0aGlzLnJldmlzaW9uICs9IDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnZpc2libGVSZXZpc2lvbiA9IHRoaXMucmV2aXNpb247XG4gICAgICAgIGlmICh0aGlzLmRlYnVnKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ1NFVFRJTkcgVklTSUJMRSBSRVZJU0lPTicsIHRoaXMudmlzaWJsZVJldmlzaW9uLCAnTEFTVCBNRVNTQUdFJywgdGhpcy5tZXNzYWdlc1t0aGlzLm1lc3NhZ2VzLmxlbmd0aCAtIDFdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JJbnB1dChlbmFibGVUZXh0SW5wdXQ/KSB7XG4gICAgZW5hYmxlVGV4dElucHV0ID0gKGVuYWJsZVRleHRJbnB1dCAhPT0gZmFsc2UpO1xuICAgIGxldCBhY3RpdmVFbGVtZW50OiBIVE1MRWxlbWVudCB8IG51bGwgPSBudWxsO1xuICAgIGlmIChlbmFibGVUZXh0SW5wdXQpIHtcbiAgICAgIGF3YWl0IHRoaXMucXVldWVGdW5jdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmRlYnVnKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ0VOQUJMSU5HIElOUFVUJyk7XG4gICAgICAgIH1cbiAgICAgICAgYWN0aXZlRWxlbWVudCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgIHRoaXMuaW5wdXRFbmFibGVkID0gdHJ1ZTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5pbnB1dHMucGlwZShcbiAgICAgICAgZmlyc3RfKCksXG4gICAgICAgIHRhcCgodmFsdWUpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5kZWJ1Zykge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ0RJU0FCTElORyBJTlBVVCwgdmFsdWU9JywgdmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLmlucHV0RW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdGT0NVU0lORycsIGFjdGl2ZUVsZW1lbnQpO1xuICAgICAgICAgIGFjdGl2ZUVsZW1lbnQ/LmZvY3VzKCk7XG4gICAgICAgIH0pXG4gICAgICApLnRvUHJvbWlzZSgpO1xuICB9XG5cbiAgc2V0UXVldWVUaW1lb3V0KHRpbWVvdXQpIHtcbiAgICBsZXQgcmVwb3J0ID0gZmFsc2U7XG4gICAgaWYgKHRoaXMudGltZW91dCA9PT0gMCAmJiB0aW1lb3V0ICE9PSAwKSB7XG4gICAgICByZXBvcnQgPSB0cnVlO1xuICAgIH1cbiAgICB0aGlzLnRpbWVvdXQgPSB0aW1lb3V0O1xuICAgIGlmIChyZXBvcnQpIHtcbiAgICAgIHRoaXMucmVwb3J0VXBkYXRlZChudWxsKTtcbiAgICB9XG4gIH1cblxufVxuIl19